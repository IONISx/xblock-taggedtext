function TaggedTextXBlockStudio(a,b){$(function(){var c=new TaggedText.Server(a,b),d=new TaggedText.StudioView(c,a);d.render(b)})}"undefined"!=typeof TaggedText&&TaggedText||(TaggedText={}),TaggedText.Server=function(){this.constructor.apply(this,arguments)},TaggedText.Server.prototype={constructor:function(a,b){this.runtime=a,this.element=b},url:function(a){return this.runtime.handlerUrl(this.element,a)},updateXml:function(a){var b=this.url("update_xml"),c=JSON.stringify({xml:a});return $.Deferred(function(a){$.ajax({type:"POST",url:b,data:c}).done(function(b){b.success?a.resolve():a.rejectWith(this,[b.msg])}).fail(function(){a.rejectWith(this,["This problem could not be saved."])})}).promise()},loadXml:function(){var a=this.url("xml");return $.Deferred(function(b){$.ajax({type:"POST",url:a,data:JSON.stringify(null)}).done(function(a){a.success?b.resolveWith(this,[a.xml]):b.rejectWith(this,[a.msg])}).fail(function(){b.rejectWith(this,["This problem could not be loaded."])})}).promise()}},TaggedText.StudioView=function(){this.constructor.apply(this,arguments)},TaggedText.StudioView.prototype={constructor:function(a,b){this.runtime=b,this.server=a,this.xmlEditor=null},load:function(){var a=this;this.server.loadXml().done(function(b){a.xmlEditor.setValue(b)}).fail(function(b){a.showError(b)})},save:function(){if(!this.xmlEditor)return void this.showError("View not rendered yet, cannot save");var a=this.xmlEditor.getValue();this.runtime.notify("save",{state:"start"});var b=this;this.server.updateXml(a).done(function(){b.runtime.notify("save",{state:"end"}),b.load()}).fail(function(a){b.showError(a)})},cancel:function(){this.runtime.notify("cancel",{})},showError:function(a){this.runtime.notify("error",{msg:a})},render:function(a){a=$(a),this.xmlEditor=CodeMirror.fromTextArea(a.find(".taggedtext-editor").get(0),{mode:"xml",lineNumbers:!0,lineWrapping:!0});var b=this;a.find(".taggedtext-save-button").click(function(){b.save()}),a.find(".taggedtext-cancel-button").click(function(){b.cancel()}),this.load()}};