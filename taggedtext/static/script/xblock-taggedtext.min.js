function TaggedTextXBlockStudio(a,b){$(function(){var c=new TaggedText.Server(a,b),d=new TaggedText.StudioView(c,a,b);d.render()})}function TaggedTextXBlockStudent(a,b){$(function(){var c=new TaggedText.Server(a,b),d=new TaggedText.StudentView(c,a,b);d.render()})}"undefined"!=typeof TaggedText&&TaggedText||(TaggedText={}),TaggedText.Server=function(){this.constructor.apply(this,arguments)},TaggedText.Server.prototype={constructor:function(a,b){this.runtime=a,this.element=b},url:function(a){return this.runtime.handlerUrl(this.element,a)},selectCategory:function(a){var b=this.url("select_category"),c=JSON.stringify({keyword:a.keyword,category:a.category});return $.Deferred(function(a){$.ajax({type:"POST",url:b,data:c}).done(function(b){b.success?a.resolve(b):a.rejectWith(this,[b.msg])}).fail(function(){a.rejectWith(this,["Could not save the selected category"])})}).promise()},check:function(){var a=this.url("check"),b=JSON.stringify(null);return $.Deferred(function(c){$.ajax({type:"POST",url:a,data:b}).done(function(a){a.success?c.resolve(a):c.rejectWith(this,[a.msg])}).fail(function(){c.rejectWith(this,["Could not check problem"])})}).promise()},edit:function(a){var b=this.url("edit"),c=JSON.stringify(a);return $.Deferred(function(a){$.ajax({type:"POST",url:b,data:c}).done(function(b){b.success?a.resolve():a.rejectWith(this,[b.msg])}).fail(function(){a.rejectWith(this,["This problem could not be saved."])})}).promise()},loadXml:function(){var a=this.url("xml");return $.Deferred(function(b){$.ajax({type:"POST",url:a,data:JSON.stringify(null)}).done(function(a){a.success?b.resolveWith(this,[a.xml]):b.rejectWith(this,[a.msg])}).fail(function(){b.rejectWith(this,["This problem could not be loaded."])})}).promise()}},TaggedText.StudioView=function(){this.constructor.apply(this,arguments)},TaggedText.StudioView.prototype={constructor:function(a,b,c){this.runtime=b,this.server=a,this.element=$(c),this.xmlEditor=null},load:function(){var a=this;this.server.loadXml().done(function(b){a.xmlEditor.setValue(b)}).fail(function(b){a.showError(b)})},save:function(){if(!this.xmlEditor)return void this.showError("View not rendered yet, cannot save");var a=this.xmlEditor.getValue(),b=this.element.find("#settings-tab"),c=b.data("metadata");this.element.find(".metadata_entry").each(function(){var a=$(this).find(".setting-input");c[a.data("field-name")].value=a.val()}),this.runtime.notify("save",{state:"start"});var d=this;this.server.edit({metadata:c,xml:a}).done(function(){d.runtime.notify("save",{state:"end"}),d.load(),b.data("metadata",c)}).fail(function(a){d.showError(a)})},cancel:function(){this.runtime.notify("cancel",{})},showError:function(a){this.runtime.notify("error",{msg:a})},setupEvents:function(){var a=this;this.element.on("click",".save-button",function(){a.save()}),this.element.on("click",".cancel-button",function(){a.cancel()})},render:function(){this.xmlEditor=CodeMirror.fromTextArea(this.element.find(".xml-editor").get(0),{mode:"xml",lineNumbers:!0,lineWrapping:!0}),this.setupEvents(),this.load()}},TaggedText.StudentView=function(){this.constructor.apply(this,arguments)},TaggedText.StudentView.prototype={constructor:function(a,b,c){this.runtime=b,this.server=a,this.element=$(c),this.state=this.element.find(".taggedtext").data("state")||{answers:[]}},setupEvents:function(){var a=this,b=this.element.find(".keyword");b.click(function(){$(this).toggleClass("active").find(".dropdown").toggle(),b.not(this).removeClass("active").find(".dropdown").hide()}),$(document).click(function(b){var c=a.element.find(".keyword.active");c.is(b.target)||c.has(b.target).length||c.removeClass("active").find(".dropdown").hide()}),this.element.find(".dropdown > li").click(function(){if(a.state.locked)return!1;var b=$(this),c=b.closest(".keyword");a.server.selectCategory({keyword:c.data("position"),category:b.data("id")}).done(function(d){c.data("color",b.find("span").css("background-color")),a.state=d.state,a.refresh()}).fail(function(){})}),this.element.find(".action .check").click(function(){return a.state.locked?!1:void a.server.check().done(function(b){a.state=b.state,a.refresh()}).fail(function(){})})},_colorizeKeyword:function(a,b){if(a.toggleClass("graded",b.graded),a.toggleClass("correct",b.graded&&b.correct),a.toggleClass("incorrect",b.graded&&!b.correct),b.graded)a.removeAttr("style").find(".dropdown").removeAttr("style");else{var c=a.data("color");c&&a.css({"background-color":c,"border-color":c}).find(".dropdown").css({"border-color":c})}},_highlightAnswer:function(a,b){var c=a.find("li"),d=c.filter(function(){return b.answer===$(this).data("id")});if(c.removeClass("active"),d.addClass("active"),b.real_answer){var e=c.filter(function(){return b.real_answer===$(this).data("id")});c.removeClass("real-answer"),e.addClass("real-answer")}},_displayAttemptsInfo:function(a,b){if(b.resolved)a.text(b.attempts>1?"Bravo ! Vous avez résolu le problème en "+b.attempts+" essais.":"Bravo ! Vous avez résolu le problème en un seul essai.");else if(b.max_attempts){var c=b.max_attempts-b.attempts;a.text(c>1?"Il vous reste "+c+" essais !":c>0?1===b.max_attempts?"Attention, vous n’avez qu’un seul essai !":"Attention, il ne vous reste qu’un essai !":b.max_attempts>1?"Vous avez épuisé vos "+b.max_attempts+" essais…":"Vous n’aviez qu’un seul essai, dommage…")}},refresh:function(){var a=this;this.element.find(".attempts").text(this.state.attempts);var b=this.element.find(".categories .category");b.each(function(){var b=$(this),c=b.data("id");b.find(".count").text(a.state.counts[c]||0)});var c=this.element.find(".text .keyword");c.toggleClass("locked",this.state.locked),c.each(function(){var b=$(this),c=b.data("position"),d=$.grep(a.state.answers,function(a){return a.position===c});d.length&&(d=d[0],a._colorizeKeyword(b,d),a._highlightAnswer(b,d))}),this.element.find("input.check").toggleClass("disabled",this.state.locked),this._displayAttemptsInfo(this.element.find(".submission_feedback"),this.state)},render:function(){this.setupEvents(),this.refresh()}};